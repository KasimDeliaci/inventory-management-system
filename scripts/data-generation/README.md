# Data Generation (Forecast Simulator)

This project simulates a coherent "world" that emits both:
- DB-consistent operational data (seed SQL for master data first; orders/stock later), and
- Training datasets for a next-7-days demand forecast service.

It is parameterized via a YAML config (`world.yaml`) and designed to honor the inventory schema (V1–V7) and API behaviors documented in the repo.

## Quick Start

1) Create a virtualenv and install deps:
   `pip install -r scripts/data-generation/requirements.txt`

2) Generate master seed SQL + calendar + campaigns (defaults, no CLI args):
   `python scripts/data-generation/generate.py`

   - Config default: `scripts/data-generation/world.yaml`
   - Output default: `scripts/data-generation/out/sql/00_master_seed.sql`

   You can still override if needed:
   `python scripts/data-generation/generate.py --config path/to/world.yaml --outdir path/to/out`

This writes:
- `out/sql/00_master_seed.sql` (products, suppliers, customers, product-suppliers)
- `out/calendar/daily_calendar.csv` (official holidays, Ramadan window, weekends, special days)
- `out/sql/10_campaigns.sql` (campaigns, assignments, customer special offers)
- `out/campaigns/product_campaigns.csv` and `out/campaigns/customer_offers.csv` (for analysis)

3) Generate demand (choose product):
   - All products (default): `python scripts/data-generation/generate.py --product all`
   - Single product:        `python scripts/data-generation/generate.py --product 1009`

   Outputs:
   - `out/datasets/demand/product_<id>.csv`
   - `out/datasets/demand/all_products.csv` (when selecting all)

   Tuning volumes:
   - Edit `meta.demand_scale` in `world.yaml` (default 1.0). For ~10× higher volumes, set `demand_scale: 10.0` and rerun.

4) Plot demand
   - Monthly (x=1..31):
     `python scripts/data-generation/plot_demand.py --product 1009 --monthly --month 2024-07`
     (omit --month to use the latest month in the data)
   - Yearly (x=1..12 months):
     `python scripts/data-generation/plot_demand.py --product 1009 --yearly --year 2024`
     (omit --year to use the latest year in the data)
   - All (quarters over years):
     `python scripts/data-generation/plot_demand.py --product 1009 --all`

   You can also pass a CSV filename instead of an id:
     `python scripts/data-generation/plot_demand.py --product all_products.csv --yearly`

   Outputs:
   - `out/plots/monthly/*.png`, `out/plots/yearly/*.png`, `out/plots/all/*.png`


5) Sales orders (Phase A)
   The generator now also emits sales orders and items using customer offers and product campaigns (stacked discounts), ignoring stock:
   - SQL: `out/sql/20_sales_orders.sql`, `out/sql/21_sales_order_items.sql`
   - CSV: `out/sales/orders.csv`, `out/sales/order_items.csv`
   - Product-day aggregates: `out/datasets/demand/product_day_sales.csv` (observedSales, offerActiveShare)

   Tuning (in `world.yaml`): `order_policy`
   - `base_rate_per_segment`, `weekend_mult_per_segment`
   - `basket_size_probs` (1–3 lines)
   - `offer_uplift_alpha`
   - `segment_category_affinity` (weights per segment)
   - `countable_qty_probs`, `noncountable_default_qty`

   Alignment with demand:
   - `orders_follow_demand: true` (default in `order_policy`) makes orders consume the daily demand budgets per product/date. Result: `observedSales` ≈ `demand` totals.
   - If you set `orders_follow_demand: false`, orders are generated from per-customer propensities; `observedSales` will differ from `demand` (useful for more stochastic behavior).
   - Customer offers influence both ordering (via `offer_uplift_alpha`) and line discounts (stacked with product campaigns). `offerActiveShare` reports the share of units sold under active offers per product-day.


## Roadmap

- v0: master data + product-suppliers seed SQL (this commit)
- v1: calendar/events/promotions generator (TR holidays, Ramadan, weekends)
- v2: demand model (seasonality, events, promos, noise)
- v3: sales orders + reservations + shipments (stock movements, current_stock)
- v4: purchase orders + partial receipt policy compatible with V7 movement uniqueness
- v5: training dataset export (daily product-level features + 7-day targets)

## Notes

- IDs: We use explicit integer IDs for products/suppliers/customers to align with `GENERATED BY DEFAULT AS IDENTITY` columns (PostgreSQL allows explicit values).
- UoM: Must be one of the allowed values in `V2__core_master_tables.sql`.
- Promotions and advanced flows will be added after we lock the product set and base parameters.
